\documentclass[10pt, openany]{book}

\usepackage{fancyhdr}
\usepackage{imakeidx}

\usepackage{amsmath}
\usepackage{amsfonts}

\usepackage{geometry}
\geometry{letterpaper}

\usepackage{fancyvrb}
\usepackage{fancybox}

\usepackage{url}
\usepackage{multicol}
%
% Rules to allow import of graphics files in EPS format
%
\usepackage{graphicx}
\DeclareGraphicsExtensions{.eps}
\DeclareGraphicsRule{.eps}{eps}{.eps}{}
%
%  Include the listings package
%
\usepackage{listings}
%
%  Define Tiny Lisp based on Common Lisp
%
\lstdefinelanguage[Tiny]{Lisp}[]{Lisp}{morekeywords=[13]{atomp, bit-vector-p, car, cdr, char-downcase, char-code, char-upcase, compiled-function-p, dowhile, dump, exit, fresh-line, if, code-char, lambda, msg, nullp, parse-integer, peek8, peek16, peek32, poke8, poke16, poke32, progn, quote, read-line, reset, setq, simple-bit-vector-p, simple-string-p, simple-vector-p, string-downcase, string-upcase}}
%
% Macro definitions
%
\newcommand{\operation}[1]{\textbf{\texttt{#1}}}
\newcommand{\package}[1]{\texttt{#1}}
\newcommand{\function}[1]{\texttt{#1}}
\newcommand{\constant}[1]{\emph{\texttt{#1}}}
\newcommand{\keyword}[1]{\texttt{#1}}
\newcommand{\datatype}[1]{\texttt{#1}}
\newcommand{\tl}{Tiny-Lisp}
\newcommand{\cl}{Common Lisp}
%
% Front Matter
%
\title{Tiny Lisp Interpreter}
\author{Brent Seidel \\ Phoenix, AZ}
\date{ \today }
%========================================================
%%% BEGIN DOCUMENT
\begin{document}
%
% Produce the front matter
%
\frontmatter
\maketitle
\begin{center}
This document is \copyright 2024 Brent Seidel.  All rights reserved.

\paragraph{}Note that this is a draft version and not the final version for publication.
\end{center}
\tableofcontents

\mainmatter
%----------------------------------------------------------
\chapter{Introduction}
This document provides a definition of a \tl\ interpreter written in Ada.  Without such a definition, it is difficult to determine if the language is actually doing what it should be doing.  This makes debugging more complicated.

\section{What is This?}
This is a \tl\ interpreter written in Ada.  It is designed to provide a language that can be embedded into other programs, including running on embedded systems without an operating system.  As a result, effort has been made to remove dependencies on Ada packages that may not be available.  A primary example is \package{Ada.Text\_IO}.  Another feature that may be missing is dynamic memory allocation.

\section{Why is This?}
As a young lad, I learned to program on 8-bit computers with minimal BASIC interpreters and 4-16K of RAM.  With these simple systems, one had a hope of being able to understand the complete system at a fairly low level.  Now, one can buy small computers like the Arduino Due with 32-bit processors, 96K of RAM, and 512K of flash memory (I'm ignoring systems like the Raspberry PI as they are full up Linux computer and thus are more complicated).  This seemed like a reasonable platform for recreating the early experience.

\subsection{Why Lisp?}
Why not?  My first thought was to use some flavor of Tiny BASIC which would have more in common with those early systems.  I then realized that Lisp is much easier to parse.  Being somewhat lazy and interested in various computer languages, I decided that some form of a ``\tl'' would be a good idea.

\tl\ can be thought of as a small subset of \cl, with some extensions of use to embedded systems.  Most of the more complex features of \cl\ are not and probably never will be available in this \tl.  However, one should be able to write code in \tl\ and have it actually run on a \cl\ system.

\subsection{Why Ada?}
Again, why not?  I have developed an interest in Ada, especially for programming embedded systems.  It has features, such as strong typing, which can help to catch errors early, thus saving time debugging.  I would not claim to be the world's greatest programmer, so I need all the help that I can get.

%----------------------------------------------------------
\chapter{The Language}
As a ``\tl'', some (many) of the features of \cl\ are not available.  Some of the lacks may be temporary while others will be permanent, and some may be added by the host program.

\section{User Interface}
The interpreter reads text from an input device, parses it, and and executes it.  The function used to read the input must match the signature for \function{Ada.Text\_IO.Get\_Line()} and this will probably be used if that is available.  On an embedded system without \package{Ada.Text\_IO}, the user must provide a suitable function.

\subsubsection{Comments}
A comment starts with a semicolon character, ``;'', and extends to the end of the line.  Any text in a comment is ignore by the interpreter.

\subsubsection{Continuation}
If a list isn't closed (number of open parentheses matches the number of close parentheses) by the end of the line, the interpreter will ask for more text.  This will continue until the list is closed.

\section{Optimization}
None.  Some could possibly be added, but right now the focus has been on getting things to work correctly.

\section{Reserved Tokens}
The following tokens are defined as fixed symbols by \tl{} and cannot be redefined.
\begin{multicols}{4}
  \keyword{+}\\
  \keyword{-}\\
  \keyword{*}\\
  \keyword{/}\\
  \keyword{=}\\
  \keyword{/=}\\
  \keyword{$<$}\\
  \keyword{$>$}\\
  \keyword{AND}\\
  \keyword{ARRAYP}\\
  \keyword{ATOMP}\\
  \keyword{BIT-VECTOR-P}\\
  \keyword{CAR}\\
  \keyword{CDR}\\
  \keyword{CHAR}\\
  \keyword{CHAR-CODE}\\
  \keyword{CHAR-DOWNCASE}\\
  \keyword{CHAR-UPCASE}\\
  \keyword{CHARACTERP}\\
  \keyword{CODE-CHAR}\\
  \keyword{COERCE}\\
  \keyword{COMPILED-FUNCTION-P}\\
  \keyword{COMPLEXP}\\
  \keyword{CONCATENATE}\\
  \keyword{CONS}\\
  \keyword{CONSP}\\
  \keyword{DEFUN}\\
  \keyword{DOLIST}\\
  \keyword{DOTIMES}\\
  \keyword{DOWHILE}\\
  \keyword{DUMP}\\
  \keyword{ERRORP}\\
  \keyword{ERR\_ADDON}\\
  \keyword{ERR\_ALLOCCONS}\\
  \keyword{ERR\_ALLOCSTR}\\
  \keyword{ERR\_ALLOCSYM}\\
  \keyword{ERR\_FEWPARAM}\\
  \keyword{ERR\_FIXSYM}\\
  \keyword{ERR\_HARDWARE}\\
  \keyword{ERR\_NOPARAM}\\
  \keyword{ERR\_NOTSYM}\\
  \keyword{ERR\_PARSE}\\
  \keyword{ERR\_PARSECHAR}\\
  \keyword{ERR\_PARSELIST}\\
  \keyword{ERR\_PARSESPEC}\\
  \keyword{ERR\_RANGE}\\
  \keyword{ERR\_STACK}\\
  \keyword{ERR\_UNKNOWN}\\
  \keyword{ERR\_WRONGTYPE}\\
  \keyword{EVAL}\\
  \keyword{EXIT}\\
  \keyword{FLOATP}\\
  \keyword{FRESH-LINE}\\
  \keyword{FUNCTIONP}\\
  \keyword{IF}\\
  \keyword{INTEGERP}\\
  \keyword{LAMBDA}\\
  \keyword{LENGTH}\\
  \keyword{LET}\\
  \keyword{LIST}\\
  \keyword{LISTP}\\
  \keyword{MSG}\\
  \keyword{NOT}\\
  \keyword{NULL}\\
  \keyword{NUMBERP}\\
  \keyword{OR}\\
  \keyword{PACKAGEP}\\
  \keyword{PARSE-INTEGER}\\
  \keyword{PEEK8}\\
  \keyword{PEEK16}\\
  \keyword{PEEK32}\\
  \keyword{POKE8}\\
  \keyword{POKE16}\\
  \keyword{POKE32}\\
  \keyword{PRINT}\\
  \keyword{PRINT-HEX}\\
  \keyword{PROGN}\\
  \keyword{RATIONALP}\\
  \keyword{READ}\\
  \keyword{READ-LINE}\\
  \keyword{REALP}\\
  \keyword{RETURN}\\
  \keyword{RPLACA}\\
  \keyword{RPLACD}\\
  \keyword{SETQ}\\
  \keyword{SIMPLE-BIT-VECTOR-P}\\
  \keyword{SIMPLE-STRING-P}\\
  \keyword{SIMPLE-VECTOR-P}\\
  \keyword{SLEEP}\\
  \keyword{STRING-DOWNCASE}\\
  \keyword{STRING-UPCASE}\\
  \keyword{STRINGP}\\
  \keyword{SUBSEQ}\\
  \keyword{SYMBOLP}\\
  \keyword{T}\\
  \keyword{TERPRI}\\
  \keyword{VECTORP}\\
\end{multicols}

\section{Syntax}

\subsection{Special Characters}
There are only a few characters with special significance.  Parenthesis, ``('' and ``)'', are used for delimiting lists.  Quotation marks, ``"'' are used for delimiting strings.  The apostrophe `` ' '' is used for quoting symbols or lists.  The semicolon, ``;'', indicates a comment.  The pound sign (octothorp) ``\#'' is used to indicate certain special processing.  Spaces are used to separate elements in a list.  That's about it.  However, it's probably best to avoid most symbol characters since some more special characters may be added.  A good rule of thumb would be to avoid any special characters that are used by \cl.

The language is case insensitive thus, \function{CAR}, \function{car}, \function{cAr}, etc all are considered identical by the language.

\subsection{Reserved Words}
There are almost none.  \constant{T} and \constant{NIL} refer to the boolean true and false values, and you can't define a symbol that it already used for a builtin or special operation.  However, even the builtin and special operations are not, strictly speaking, reserved words.  Their names are strings that are added to the symbol table during program initialization.  They can easily be changed (say to translate into a different language) and the interpreter recompiled.

\subsection{Examples}
The basic syntax for languages in the Lisp family is very simple.  Everything is a list of elements, where each element may also be a list.  Elements are separated by spaces and the list is contained in parentheses.  Here is a simple list:
\lstset{language=[Tiny]Lisp}
\begin{lstlisting}
(+ 1 2 3)
\end{lstlisting}
The first element in the list is the symbol ``+''.  The following elements are ``1'', ``2'', and ``3''.  The ``+'' symbol is the addition operation and adds the following integers together.  Thus, the example would return the integer ``6''.

A more complicated example:
\begin{lstlisting}
(+ (* 2 3) (* 4 5))
\end{lstlisting}
This is equivalent to $2*3+4*5$.  Breaking this down, the first element of the outside list is ``+''.  The second element is the list \operation{(* 2 3)} and the third element is the list \operation{(* 4 5)}.  Since ``*'' is the symbol for the multiplication operation, this returns a value of 26.

A final example:
\begin{lstlisting}
(print "Hello World!")
\end{lstlisting}
This list consists of only two elements.  The first is the symbol \function{print}.  The second is the string ``Hello World!''.  With strings, everything from the starting quotation mark to the next quotation mark is part of the string.  This means that you can't have a string that contains a quotation mark (at some point, a work-around may be available).

\section{Symbols and Variables}
Elements that are not numbers, strings, or lists are symbols or variables.  In determining what the element represents, the search order is:
\begin{enumerate}
  \item Boolean literals are checked first.
  \item Builtin or Special symbols are checked next.
  \item Variables in the most recent stack frame.
  \item Variables in older stack frames.
  \item Variable symbols are checked last.  These can be considered to be global variables.
\end{enumerate}

All symbols share the same namespace.  This makes this \tl\ a LISP-1 (for those who are interested in such things).  It is possible that this will change at some point.

Another thing to be aware of is that if a function is defined within a function definition or local block, the inner definition may reference locals or parameters in the outer blocks.  In \cl, this creates a closure where the variables remain accessible.  This does not work in \tl\ and may cause an error when the function is called.  It is best to define functions are the top level for now.  For example, consider the following:
\begin{lstlisting}
(let ((a 10)) (defun test (b) (print "Sum is " (+ a b)) (terpri))
  (test 5))
(test 6)
(let ((a 20)) (test 7))
(let ((b 30)) (test 8))
\end{lstlisting}

The first call \operation{(test 5)} produces ``Sum is  15''.  The second \operation{(test 6)} and fourth \operation{(test 8)} calls produce an error.  The third call \operation{(test 7)} produces ``Sum is  27''.

\section{Operations}
A limited number of operations are defined.  Note that this list will probably be expanded.

\subsection{Normal Forms vs Special Forms}
A number of normal forms are defined.  The main difference between normal forms and special forms is that all active arguments for a normal form are evaluated.  Thus:
\begin{lstlisting}
(* (+ 1 2) (+ 3 4))
;
; Versus
;
(if (> 1 2) (+ 1 2) (+ 3 4))
\end{lstlisting}
``*'' is a normal operation and both \operation{(+ 1 2)} and \operation{(+ 3 4)} are evaluated before ``*'' is evaluated.  \operation{If} is a special form so first \operation{(> 1 2)} is evaluated, then depending on whether the result is \function{T} or \constant{NIL}, either \operation{(+ 1 2)} or \operation{(+ 3 4)} is evaluated.  For a simple example like this, it doesn't really matter, but if the operations have other effects, such as:

\begin{lstlisting}
(if (> 1 2) (print "Greater") (print "Not greater"))
\end{lstlisting}

will only print ``Not greater''.

\subsection{Arithmetic Operations}
Four arithmetic operations are defined for operation on integers.  The operations are addition, subtraction, multiplication, and division.  For example:
\begin{lstlisting}
(+ 1 2 3 4)
(- 1 2 3 4)
(* 1 2 3 4)
(/ 1 2 3 4)
\end{lstlisting}

These operations work on a list of one or more parameters, with the operation inserted between the parameters.  Thus \operation{(+ 1 2 3 4)} computes as $1+2+3+4$.  The return value for each of these operations is an integer value.

Note that division by zero is not checked.  If this occurs, an Ada exception will be thrown.  In some cases, this might be useful.

\subsection{Boolean Operations}
Three basic boolean operations are provided.  These work on either boolean or integer variables.
\begin{lstlisting}
(not NIL)
(and 1 5 7)
(or 1 2 4)
\end{lstlisting}

The \function{not} operation operates on a single parameter.  If the parameter is boolean, the return value is the inverse of the parameter (\constant{NIL} $\rightarrow$ \constant{T}, \constant{T} $\rightarrow$ \constant{NIL}).  If the parameter is integer, the individual bits of the integer are inverted and the resulting value returned.

The \function{and} and \function{or} operations operate on either booleans or integers as long as they are not mixed.  These perform the logical \function{and} and \function{or} operations.  Both of these operations short circuit.  As soon as the result is \constant{T} or -1 or \function{or} or \constant{NIL} or 0 for \function{and},  processing additional parameters will not change the result so evaluation of parameters stops and the result is returned.

\subsection{Character Operations}
The normal comparison operations work on characters.  There are also some operations defined to operate on characters.
\begin{lstlisting}
(char-downcase #\A)
(char-code #\B)
(char-upcase #\c)
(code-char 65)
\end{lstlisting}

The \function{char-code} and \function{code-char} operations convert between characters and their integer codes.  Given an integer in the range 0-255, \function{code-char} returns the corresponding character value.  Given a character value, the function \function{char-code} returns the corresponding integer (usually the ASCII code.

The \function{char-downcase} and \function{char-upcase} operations convert characters between upper and lower case.  Non-alphabetic characters are not changed.

\subsection{Comparison Operations}
Four comparison operations are defined for integers, strings, and booleans  Note that this is different from \cl{} which has separate operations defined for different types.  The operations are equals, not equals, greater than, and less than.  Equality and not equality is also defined for quoted symbols.  For example:

\begin{lstlisting}
(= 1 2)
(/= 1 2)
(< 1 2)
(> 1 2)
\end{lstlisting}
These operations work on two parameters of the same type.  The return value of each of these operations is a boolean.

\subsection{Control Flow}
A couple of control flow special forms are available.  More will probably be added.

\begin{lstlisting}
(if (> 1 2) (print "True") (print "False"))
(dowhile (> 1 2) (print "Forever") (terpri))
(dotimes (n 5 10) (print "This is printed 5 times") (terpri))
\end{lstlisting}

The \function{if} form has two or three parameters.  The first parameter is a condition.  If the condition evaluates to \function{T}, then the second parameter is evaluated.  If the condition evaluates to \function{NIL}, then the third parameter, if present, is evaluated.

The \function{dowhile} form has two parameters.  The first is a condition.  The second is a list of operations to be evaluated.  The second parameter is evaluated as long as the condition evaluates to \constant{T}.

The \function{dotimes} form also has two parameters.  The first is a list with two or three elements.  The first element is the name of the local variable used as a loop counter.  The second element is a positive integer giving the number of times to loop.  The third is a value to return at the end of the loop.  If the return value is not provided, \constant{NIL} is returned.  The second parameter is a list of operations to be evaluated.

\subsection{Debugging}
Some additional operations are provided for debugging purposes.  These control the display of some debugging information.

\begin{lstlisting}
(dump)
(msg T)
(msg NIL)
\end{lstlisting}

The \function{dump} operation prints the contents of the cons, symbol, and string tables.  The \function{msg} operation turn the display of debugging information on and off.  These are helpful when trying to debug the interpreter and should not be necessary during normal operation.

\subsection{Functions}
\begin{lstlisting}
(defun fib (n)
  (if (< n 2)
    1
    (+ (fib (- n 2)) (fib (- n 1)))))
(lambda (a b) (+ a b))
\end{lstlisting}

the \function{defun} form is used to create a user defined function.  The first parameter is a symbol for the function name.  The second parameter is a list of the parameters for the function.  If the function has no parameters, the empty list ``()'' is used.  Following this is a list of statements for the function.  The function returns the value from the last statement to return a value.\\

The \function{lambda} form returns a user defined function.  This function can be assigned to a variable or passed as a parameter to another function.

\subsection{Input/Output}
As this Lisp may run on systems without filesystems, only a few operations are provided for input and output.  These are:

\begin{lstlisting}
(print "Strings " 1 2 N)
(fresh-line)
(read-line)
(terpri)
\end{lstlisting}

The \function{print} form prints the list of objects to the standard output.  No newline is added to the end.  It returns \constant{NIL\_ELEM}.

The \function{fresh-line} prints a newline to the standard output if the output is not already at the start of a line.  It returns \constant{NIL\_ELEM}.

The \function{read-line} reads a line of text from the standard input, terminated by a newline.  It returns the text as a string without the newline.

The \function{terpri} prints a newline to the standard output.  It returns \constant{NIL\_ELEM}.

\subsection{List Operations}
Basic list operations are provided.
\begin{lstlisting}
(car (1 2 3 4))
(cdr (1 2 3 4))
(cons 1 (cons 2 ()))
(quote (+ 1 2) 3 4 (* 5 6 7 8))
(list (+ 1 2) 3 4 (* 5 6 7 8))
\end{lstlisting}

Each of \function{car} and \function{cdr} take one parameter that should be a list.  \function{Car} returns the first item in the list.  This item may be a single element or it may be a list.  \function{Cdr} returns the remainder of the list.

The \function{cons} operation creates a \constant{cons} cell and sets the \constant{car} field to the first parameter and the \constant{cdr} to the second parameter.  This exposes a subtle difference between \tl{} and \cl.  In \tl, \constant{NIL} is a constant of boolean type, while in \cl, it also represents an empty list.  Thus \operation{(cons 1 NIL)} produce slightly different results, \operation{(1 . NIL)} for \tl{} or \operation{(1)} for \cl.  If you wish to produce the \cl{} results, where the \constant{car} points to a value and the \constant{cdr} is an empty pointer, you can use \operation{(cons 1 ())} or \operation{(cons 1)}.  The former is preferred as it is compatible with \cl.

The \function{list} operation returns its parameters as a list after evaluating each of them.  This is similar to \function{quote} except that quote does not evaluate the parameters.  Thus \operation{(quote (+ 1 2) 3 4 (* 5 6 7 8))} returns \operation{((+ 1 2) 3 4 (* 5 6 7 8))}, while \operation{(list (+ 1 2) 3 4 (* 5 6 7 8))} returns \operation{(3 3 4 1680)}.

The \function{quote} operation returns its parameters as a list without evaluating any of them.  In many cases this is not needed since if the first item in a list is not a symbol representing an operation or user defined function, the list simply evaluates to itself.  At some point, this may change to be more compatible with \cl.

\subsection{Memory Access}
Here be dragons!  Use at your own risk.  These operations are intended for use on embedded systems to access memory mapped peripheral devices.  Access to a memory map is essential so that you know which locations to access.
\begin{lstlisting}
(peek8 #x400E0940)
(peek16 #x400E0940)
(peek32 #x400E0940)
(poke8 #x100 5)
(poke16 #x110 10)
(poke32 #x1000 32)
\end{lstlisting}

The \function{peek} operations read 8, 16, or 32 bits from the specified memory location.  Depending on the hardware, there may be memory alignment requirements, or certain operations will only work on some addresses.  For example, the bytes of the Chip ID (CHIPID\_CIDR) register on the SAM3X8E works using \function{peek8}, but hangs when using \function{peek16} or \function{peek32}.  The returned value is the contents of memory at the specified location.

The \function{poke} operations write a 8, 16, or 32 bit value to the specified memory location.  This is even more dangerous that the \function{peek} operations.  \textbf{\textit{You have been warned!}}  The return value is the value written to the memory location.

\subsection{Predicates}
A wide variety of predicates are provided.  These mostly match the ones in \cl{}.  Note that some of these will always return \constant{NIL} due to missing features.  There may also be some differences in corner cases due to implementation differences between \cl{} and \tl.

\begin{lstlisting}
;
;  The following will always return NIL as the data types or features
;   are not implemented.
;
(arrayp (1 3 5))
(bit-vector-p (1 2 3))
(complexp +)
(floatp 3)
(vectorp (1 2 3)
(rationalp "Hello")
(realp 4)
(simple-vector-p print)
(simple-bit-vector-p #x0F0F0F0F)
(packagep "package")
(vectorp (1 2 3)
;
;  The following will return NIL or T depending on the parameter.
;
(atomp 1)
(characterp #\A)
(compiled-function-p print)
(consp (1 2 3))
(errorp (+ 1 "A"))
(functionp functionp)
(integerp 3)
(listp (2 4 6))
(numberp 4)
(null ())
(simple-string-p "Hello")
(stringp "Hello")
(symbolp car)
\end{lstlisting}

Some corner cases to watch out for are:
\begin{enumerate}
  \item \tl{} does not treat \constant{()} and \constant{NIL} exactly the same so \operation{nullp} may not always do what it does in \cl.
  \item \tl{} does not have arrays or vectors.  Strings are managed as linked lists in a separate allocation pool.  Thus \operation{stringp} and \operation{simple-string-p} are treated the same and return \constant{T} for any string and \constant{NIL} for anything else.
  \item Some of these operations evaluate the parameter to get a value to check and some do not.  It's best not to get too creative with them.
\end{enumerate}

\subsection{String Related Operations}
These operations are related to strings, but may have wider scope.
\begin{lstlisting}
(length "Hello, this is a test")
(length (list 1 2 3 4 5))
(char "This is a test string" 5)
(parse-integer "42")
(string-downcase "HELLO")
(string-upcase "hello")
(subseq "This is a test of a subsequence" 5 10)
\end{lstlisting}

The \function{length} operation works on all types.  For strings, it returns the number of characters in the string.  For lists, it returns the number of elements in a list.  For integers, characters, and booleans, it returns 1.  For an empty list, it returns 0.

The \function{char} operation returns a specific character in a string, where the first character is character number 0.

The \function{parse-integer} operation parses the passed string as an integer.  Positive and negative decimal integers are supported.  Parsing ends when a non-decimal character is encountered.

The \function{string-downcase} and \function{string-upcase} operations make a copy of the passed string and convert it to all upper or all lower case.  The original string is unchanged.

The \function{subseq} operation returns a substring of the original string.  The first parameter is the string.  The second parameter is the starting character (0 based).  The third parameter is optional.  If present, it is the index (not length of the substring) of the first character  not part of the substring.  If absent, the substring extends to the end of the original string.

\subsection{Symbol Related Operations}
Some operations use a quoted symbol to indicate what type of operation should be performed or what type of date should be returned.  These thus require a bit more description than some of the other operations.
\begin{lstlisting}
(coerce t 'integer)
(concatenate 'string "First string, " "second string, "
   "and finally the third string.")
\end{lstlisting}

The \function{coerce} operation is used to convert data of one type to another.  The current supported conversions are:
\begin{itemize}
\item Boolean $\rightarrow$ Integer
\item Boolean $\rightarrow$ String
\item Character $\rightarrow$ String
\item Integer $\rightarrow$ Boolean
\end{itemize}

Converting a type to itself is supported, but probably isn't very useful.  Also of note is that coercing a string to a string returns a string object that points to the original string data structure, not a copy.

The \function{concatenate} operation works on both strings and lists.  It constructs a new list or string that is the concatenation of the parameters.  Note that in the case of a list, elements that are lists or strings are not copied.  Only the references are copied.

\subsection{Variables}
Both global and local variables are supported.
\begin{lstlisting}
(setq variable 1)
(let (var1 (var2 2) (var3))
  (print "var1 is " var1 " var2 is " var2 "var3 is " var3)
  (terpri))
\end{lstlisting}

The \function{setq} form sets a value for a symbol or stack variable.  If a symbol and an active stack variable have the same name, the stack variable will be used.  The first parameter is the symbol and the second parameter is the value.  If the symbol does not yet exist, it is created.  Symbols that already exist as builtin or special can't be used for values.  The second parameter is evaluated to return the value.

The \function{let} form creates local variables on the stack and an environment for other statements that use them.  Variables can have an optional initial value.  If no initial value is provided, the variable is set to \constant{NIL}.  The value returned from the \function{let} form is the value of the last statement executed.

\subsection{Error Handling}
In cases where the interpreter detects an error, the current operation returns an element of type \constant{E\_ERROR}.  Currently, the only thing that can be done with this is to check if it is present using \keyword{errorp}.  It is expected that this will eventually be expanded to include error codes that can help identify what sort of error occurred.

\subsection{Other}
There are a few operations that do things that can't be easily categorized.

\begin{lstlisting}
(exit)
(sleep 1000)
\end{lstlisting}

The \function{exit} operation just exits the interpreter.  It should mainly be used from the command line.  It may cause problems in some cases if used in a function.

The \function{sleep} operation suspends program execution for the specified number of milliseconds.  This is different from \cl, where the parameter is a float in units of seconds.  Since \tl{} is integer only, this doesn't work well, thus the difference.

\section{Data Types}
A limited selection of data types is provided.  Think of the old Applesoft Integer BASIC.

\subsection{Integer}
This is a 32 bit signed integer.  Integer literals can be given as either signed decimal integers, with a minus sign, ``-'', indicating negative numbers.  This is just as one would expect, however don't use a plus sign, ``+'', to indicate positive numbers.  Integers can also be expressed as unsigned hexadecimal numbers by preceding the number by ``\#x''.

\subsection{Characters}
Character literals are introduced by preceding the literal by ``\#\textbackslash''.  The following character is the character used, with some exceptions.  The end of a line is always the end of a line, so this cannot be used to create a character containing a newline.  If the first character is alphabetic and is followed by further alphabetic characters, it is interpreted as a character name.  The defined character names are:
\begin{itemize}
\item Space
\item Newline
\item Tab
\item Page
\item Rubout
\item Linefeed
\item Return
\item Backspace
\end{itemize}
Thus, the correct way to create a character containing a newline is ``\#\textbackslash{}newline''.  Note that the character names are case insensitive.

\subsection{String}
Strings are stored in linked lists of 8-bit characters/bytes.  Each node in the list can hold 16 (adjustable by a parameter) bytes.  Unicode is not currently supported.

\subsection{Boolean}
The Boolean values \constant{NIL} and \constant{T} correspond to \constant{True} and \constant{False}.  An empty list ``()'' is also interpreted as \constant{NIL}.

\subsection{List}
The list is the basic complex data type.  A list element has two slots (historically called \constant{car} and \constant{cdr}).  Typically the \constant{car} slot contains a data value and the \constant{cdr} slot contains a pointer to the next list element.  The end of a list is indicated by a \constant{NIL} value in the \constant{cdr} slot.

\subsection{Error}
The defined \datatype{error} values listed in Table \ref{tbl:Error}.  The error codes are defined as symbols and can be used in comparison operations as follows:
\begin{lstlisting}
(if (= ERR_NOPARAM (cons))
  (progn (print "No parameter provided to cons") (terpri)))
\end{lstlisting}

\begin{table}
  \centering
  \caption{Currently defined \datatype{error} codes}
  \label{tbl:Error}
  \begin{tabular}{ l | p{12cm}}
    \hline
    \constant{ERR\_ADDON} & An error specific to an addon.  This is not generated for the core \tl{} language.  It is reserved for extensions.\\
    \hline
    \constant{ERR\_ALLOCCONS} & Unable to allocate a cons.\\
    \hline
    \constant{ERR\_ALLOCSTR} & Unable to allocate a string.\\
    \hline
    \constant{ERR\_ALLOCSYM} & Unable to allocate a symbol.\\
    \hline
    \constant{ERR\_FEWPARAM} & Too few parameters have been provided for an operation.\\
    \hline
    \constant{ERR\_FIXSYM} & Attempt to change a fixed symbol.\\
    \hline
    \constant{ERR\_HARDWARE} & A hardware related error.  This code is reserved for extension operations that interface with hardware.\\
    \hline
    \constant{ERR\_NONE} & Indicates that no error has occurred.  This is not used in the core \tl{}, but there may be some add-on routines that need a way to indicate success.\\
    \hline
    \constant{ERR\_NOPARAM} & No parameters provided for an operation when required.\\
    \hline
    \constant{ERR\_NOTSYM} &  Symbol needed, but not provided.\\
    \hline
    \constant{ERR\_PARSE} & General parse failure.\\
    \hline
    \constant{ERR\_PARSECHAR} & Error during parsing of character.\\
    \hline
    \constant{ERR\_PARSELIST} & Error during parsing of list.\\
    \hline
    \constant{ERR\_PARSESPEC} & Error during parsing of special function.\\
    \hline
    \constant{ERR\_RANGE} & Parameter value is out of range.\\
    \hline
    \constant{ERR\_STACK} & Stack function reported an error.\\
    \hline
    \constant{ERR\_UNKNOWN} & Unknown error code.  Where possible, a more specific error code should be used.\\
    \hline
    \constant{ERR\_WRONGTYPE} & Wrong data type for parameter.\\
    \hline
  \end{tabular}
\end{table}

%----------------------------------------------------------
\chapter{Operation Reference}
This is an alphabetical list of all the operations.
\section{Template}
This is the template for each operation.
\subsection{Inputs}
The inputs are listed here.
\subsection{Output}
Any output is listed here.
\subsection{Example}
An example of the operation is listed here.
\subsection{Description}
This describes the operation.  In many cases, it will be fairly simple.
\subsection{Common Lisp Compatibility}
This subsection discusses compatibility with \cl.  Usually, this will be a subset of \cl.  In some cases, it may be a superset.  For example the comparison operators work on more types than \cl{} supports.

\section{+}
Addition
\subsection{Inputs}
Any number of \datatype{integers}.
\subsection{Output}
An \datatype{integer} representing the sum of the inputs.
\subsection{Example}
\begin{lstlisting}
(+ 1 2 3)
\end{lstlisting}
Returns the value 6.
\subsection{Description}
This operation adds a series of \datatype{integers}.  Note that there is a possibility for integer overflow.
\subsection{Common Lisp Compatibility}
This is a subset of \cl{} in that it only works on \datatype{integers}.

\section{-}
Subtraction
\subsection{Inputs}
Any number of \datatype{integers}.
\subsection{Output}
An \datatype{integer} representing the difference of the inputs.  Note that there is a possibility for integer overflow.
\subsection{Example}
\begin{lstlisting}
(- 1 2 3)
\end{lstlisting}
Returns the value -4.
\subsection{Description}
This operation subtracts a series of \datatype{integers}.  This is done by starting with the first value, then subtracting the second value (if any).  The next value is subtracted from the result.
\subsection{Common Lisp Compatibility}
This is a subset of \cl{} in that it only works on \datatype{integers}.

\section{*}
Multiplication
\subsection{Inputs}
Any number of \datatype{integers}.
\subsection{Output}
An \datatype{integer} representing the product of the inputs.  Note that there is a possibility for integer overflow.
\subsection{Example}
\begin{lstlisting}
(* 1 2 3)
\end{lstlisting}
Returns the value 6.
\subsection{Description}
This operation multiplies a series of \datatype{integers}.
\subsection{Common Lisp Compatibility}
This is a subset of \cl{} in that it only works on \datatype{integers}.

\section{/}
Division
\subsection{Inputs}
Any number of \datatype{integers}.
\subsection{Output}
An \datatype{integer} representing the quotient of the inputs.  Division by zero is not checked and will cause an exception.
\subsection{Example}
\begin{lstlisting}
(/ 1 2 3)
\end{lstlisting}
Returns the value 0.
\subsection{Description}
This operation divides a series of \datatype{integers}.  This is done by starting with the first value, then dividing by the second value (if any).  The result is then divided by the next value, and so on.
\subsection{Common Lisp Compatibility}
This is a subset of \cl{} in that it only works on \datatype{integers}.

\section{=}
Equals
\subsection{Inputs}
Compares two values of the same type.
\subsection{Output}
\constant{T} if the values are equal, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(= 1 2)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This operation compares two values of the same type for equality.
\subsection{Common Lisp Compatibility}
This operation works on \datatype{integers}, \datatype{booleans}, \datatype{strings}, \datatype{symbols}, quoted \datatype{symbols}, and \datatype{errors}.  For comparison purposes, \datatype{symbols} and quoted \datatype{symbols} are considered to be the same type.

\section{/=}
Not-equals
\subsection{Inputs}
Compares two values of the same type.
\subsection{Output}
\constant{T} if the values are not equal, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(= 1 2)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This operation compares two values of the same type for not equality.
\subsection{Common Lisp Compatibility}
This operation works on \datatype{integers}, \datatype{booleans}, \datatype{strings}, \datatype{symbols}, quoted \datatype{symbols}, and \datatype{errors}.  For comparison purposes, \datatype{symbols} and quoted \datatype{symbols} are considered to be the same type.

\section{$<$}
Less Than
\subsection{Inputs}
Compares two values of the same type.
\subsection{Output}
\constant{T} if the first value is less than the second value, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(< 1 2)
\end{lstlisting}
Returns the value \constant{T}.
\subsection{Description}
This operation compares two values of the same type for less than.
\subsection{Common Lisp Compatibility}
This operation works on \datatype{integers}, \datatype{booleans}, and \datatype{strings}.

\section{$>$}
Greater Than
\subsection{Inputs}
Compares two values of the same type.
\subsection{Output}
\constant{T} if the first value is greater than the second value, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(> 1 2)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This operation compares two values of the same type for greater than.
\subsection{Common Lisp Compatibility}
This operation works on \datatype{integers}, \datatype{booleans}, and \datatype{strings}.

\section{and}
Logical or bitwise \operation{and}.
\subsection{Inputs}
Performs the logical or bitwise \operation{and} on values of the same type.
\subsection{Output}
If the input parameters are \datatype{boolean} then the output is \datatype{boolean}.  If the input parameters are \constant{integer}, the output is \datatype{integer}.
\subsection{Example}
\begin{lstlisting}
(and 1 3 4)
\end{lstlisting}
Returns the value 1.
\subsection{Description}
If the two parameters are \datatype{boolean}, the result is the logical and of the parameters.  If the two parameters are \datatype{integer}, then the result is the bitwise and of the parameters.  Processing of parameters stop when the result is either \constant{NIL} of \datatype{boolean} values, or 0 (zero) for \datatype{integer} values.
\subsection{Common Lisp Compatibility}
This operation performs a bitwise \keyword{and} for integers.  This is probably more useful for embedded systems.

\section{arrayp}
Is parameter an \datatype{array}?
\subsection{Inputs}
A single value.  Any additional values are ignored..
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(arrayp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{arrays} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{atomp}
Is parameter an atom?
\subsection{Inputs}
A single value.  Any additional values are ignored..
\subsection{Output}
\constant{T} or \constant{NIL}
\subsection{Example}
\begin{lstlisting}
(atomp 1 2 3)
\end{lstlisting}
Returns the value \constant{T}.
\subsection{Description}
Returns \constant{T} if the first value is an atom.  Returns \constant{NIL} otherwise.  Since the only non-atom datatype supported is a list, this really just checks if the value is a list.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{bit-vector-p}
Is parameter a \datatype{bit vector}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(bit-vector-p 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{bit vectors} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{car}
Returns the first element of a list
\subsection{Inputs}
If the first value is a list, return the first value of that.  Otherwise return the first value.
\subsection{Output}
The first value of a list.
\subsection{Example}
\begin{lstlisting}
(car 1 2 3)
\end{lstlisting}
Returns the value 1.
\subsection{Description}
Returns the first value of a list.  If the first value passed is a list, then return the first value of that.  Otherwise the list of parameters is treated as a list and the first value is returned.
\subsection{Common Lisp Compatibility}
If multiple parameters are passed, the first one is returned.  Compatible with \cl{} if only one parameter is passed.

\section{cdr}
Returns all but the first element of a list
\subsection{Inputs}
If the first value is a list, return all but the first value of that.  Otherwise return all but the first value.
\subsection{Output}
All but he first value of a list.
\subsection{Example}
\begin{lstlisting}
(cdr 1 2 3)
\end{lstlisting}
Returns the value (2 3).
\subsection{Description}
Returns all but the first value of a list.  If the first value passed is a list, then return all but the first value of that.  Otherwise the list of parameters is treated as a list and all but the first value is returned.
\subsection{Common Lisp Compatibility}
If multiple parameters are passed, all but the first one is returned.  Compatible with \cl{} if only one parameter is passed.

\section{char}
Returns a specified character in a string.
\subsection{Inputs}
A string and an integer.
\subsection{Output}
A character.
\subsection{Example}
\begin{lstlisting}
(char "This is a string" 5)
\end{lstlisting}
Returns the character ``i''.
\subsection{Description}
Returns the specified character in a string where the first character is number 0.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{char-code}
Returns the integer ASCII value of a character.
\subsection{Inputs}
A character.
\subsection{Output}
A character.
\subsection{Example}
\begin{lstlisting}
(char-code #\A)
\end{lstlisting}
Returns the integer 65.
\subsection{Description}
This returns the integer ASCII (you might be able to find some odd systems where this is not true) code for the provided character.  Unicode is not currently supported.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{char-downcase}
Converts a character to lower case.
\subsection{Inputs}
A character.
\subsection{Output}
A character.
\subsection{Example}
\begin{lstlisting}
(char-downcase #\A)
\end{lstlisting}
Returns the character ``a''.
\subsection{Description}
If the character passed is uppercase, convert it to lowercase and return it.  Otherwise return the character unchanged.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{char-upcase}
Converts a character to upper case.
\subsection{Inputs}
A character.
\subsection{Output}
A character.
\subsection{Example}
\begin{lstlisting}
(char-upcase #\a)
\end{lstlisting}
Returns the character ``A''.
\subsection{Description}
If the character passed is lowercase, convert it to uppercase and return it.  Otherwise return the character unchanged.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{characterp}
Is parameter a \datatype{character}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
A boolean value
\subsection{Example}
\begin{lstlisting}
(characterp 1)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Returns \constant{T} if the first value is a character.  Otherwise it returns \constant{NIL}.  Note that a string containing a single character is not the same as a character.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{code-char}
Converts an integer to a character where the integer is the ASCII representation of the character.  The integer is limited to the range 0-255.
\subsection{Inputs}
A single integer.  Any other parameters are ignored.
\subsection{Output}
The character represented by the ASCII code input.
\subsection{Example}
\begin{lstlisting}
(code-char 65)
\end{lstlisting}
Returns the character `A'.
\subsection{Description}
This can be used to generate any 8 bit ASCII character.
\subsection{Common Lisp Compatibility}
\cl{} allows a larger range than 0-255 since Unicode is supported.

\section{coerce}
Converts a value of one type to another type
\subsection{Inputs}
Two values.  The first value is the item to be converted.  The second value is a quoted symbol representing the result type.
\subsection{Output}
A value of the desired type.
\subsection{Example}
\begin{lstlisting}
(coerce NIL `integer)
\end{lstlisting}
Returns the integer value 0.
\subsection{Description}
The result is a representation of the first value in the desired type.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

Only the following coercions are supported:
\begin{itemize}
  \item character $\rightarrow$ string
  \item boolean $\rightarrow$ string
  \item boolean $\rightarrow$ integer (\constant{NIL} $\rightarrow$ 0, \constant{T} $\rightarrow$ 1).
  \item integer $\rightarrow$ boolean (0 $\rightarrow$ \constant{NIL}, $\neq$ 0 $\rightarrow$ \constant{T})
\end{itemize}

\section{compiled-function-p}
Is parameter a compiled function?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
A boolean value
\subsection{Example}
\begin{lstlisting}
(compiled-function-p print)
\end{lstlisting}
Returns the value \constant{T}.
\subsection{Description}
Returns \constant{T} if the first value is a compiled function.  Otherwise it returns \constant{NIL}.  \tl() considers the builtin intrinsic functions to be compiled.  User defined functions are not compiled..
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{complexp}
Is parameter a \datatype{complex number}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(complexp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{complex numbers} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{concatenate}
Concatenates strings or lists.
\subsection{Inputs}
A quoted symbol (either \constant{LIST} or \constant{STRING}) followed by either lists or strings.
\subsection{Output}
A list or string consisting of the concatenation of the lists or strings
\subsection{Example}
\begin{lstlisting}
(concatenate 'string "One " "Two")
\end{lstlisting}
Returns the string ``One Two''.
\subsection{Description}
Concatenates either string or lists.  The first parameter is a symbol that specifies what to concatenate.  The following parameters must be of the appropriate type.
\subsection{Common Lisp Compatibility}
This is probably a subset of the \cl{} function.  Normal cases will operate the same, but error handling is different.

\section{cond}
Evaluates the first list that starts with a \constant{T} condition.
\subsection{Inputs}
A list of lists.
\subsection{Output}
The result of the evaluated list or an error if no list matches.
\subsection{Example}
\begin{lstlisting}
(cond
  ((= 1 2)
    (print "This should never print.")
    (terpri))
  ((= 2 2)
    (print "This should get printed")
    (+ 2 3)
    (terpri))
  (T
    (print "This doesn't get printed since the previous condition was true")
    (terpri)))
\end{lstlisting}
Returns the \datatype{integer} 5.
\subsection{Description}
This is similar to an if-then-elsif chain in other programming languages.  It is passed a list of lists.  Each list is examined sequentially.  If the first item in the list evaluates to \constant{T}, then the rest of the list is evaluated in an implicit \operation{progn} block.  Once the first list is evaluated, \operation{cond} exits and returns the result of that evaluation.  Errors are returned if no list gets evaluated or if an element is encountered that is not a list.
\subsection{Common Lisp Compatibility}
This is similar to \cl{}.

\section{cons}
Combines elements into a list.
\subsection{Inputs}
One or two values
\subsection{Output}
A list consisting of the provided inputs.
\subsection{Example}
\begin{lstlisting}
(cons 1 2)
\end{lstlisting}
Returns the \datatype{list} (1 . 2).
\subsection{Description}
The \function{cons} operation creates a \constant{cons} cell and sets the \constant{car} field to the first parameter and the \constant{cdr} to the second parameter..
\subsection{Common Lisp Compatibility}
There is a subtle difference between \tl{} and \cl.  In \tl, \constant{NIL} is a constant of boolean type, while in \cl, it also represents an empty list.  Thus \operation{(cons 1 NIL)} produce slightly different results, \operation{(1 . NIL)} for \tl{} or \operation{(1)} for \cl.  If you wish to produce the \cl{} results, where the \constant{car} points to a value and the \constant{cdr} is an empty pointer, you can use \operation{(cons 1 ())} or \operation{(cons 1)}.  The former is preferred as it is compatible with \cl.

\section{consp}
Is parameter a \datatype{cons}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
A boolean.
\subsection{Example}
\begin{lstlisting}
(consp (1 2 3))
\end{lstlisting}
Returns the value \constant{T}.
\subsection{Description}
If the supplied parameter is a \datatype{cons} (a list), return \constant{T}, otherwise return \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{defun}
Defines a function.
\subsection{Inputs}
Three or more values.  The first is a symbol that becomes the function's name.  The second is a list of parameters for the function.  The remaining values are the code for the function
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(defun hello (name) (print "Hello " name))
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This creates a user defined function.
\subsection{Common Lisp Compatibility}
This is more or less a subset of \cl, except that there are probably many corner cases where things don't quite match..

\section{dolist}
Repeats a series of statements for each element in a list.
\subsection{Inputs}
Two or more values.  The first value is a list containing a local variable, the list to iterate over, and an optional return value.   The remaining values are the statements to be executed the specified number of times.
\subsection{Output}
Either the provided value or constant \constant{NIL} if no value provided.
\subsection{Example}
\begin{lstlisting}
(setq sum 0)
(dolist (x (1 2 3) 5)
  (print "The sum is " sum)
  (terpri)
  (setq sum (+ sum x)))
\end{lstlisting}
Returns the integer 5 and sets \constant{sum} to 6.
\subsection{Description}
On each pass through the loop, the local variable is set to the next value in the list.  The supplied statements are evaluated.  It is not recommended to change the value of the local variable in the body of the loop.  Once the values of the list are exhausted, the loop exits and evaluates the result, if present.
\subsection{Common Lisp Compatibility}
The declarations and tags are not supported.

\section{dotimes}
Repeats a series of statements a specific number of times.
\subsection{Inputs}
Two or more values.  The first value is a list containing a local variable, the loop count, and optionally a return value.  The remaining values are the statements to be executed the specified number of times.
\subsection{Output}
Either the provided value or constant \constant{NIL} if no value provided.
\subsection{Example}
\begin{lstlisting}
(setq sum 0)
(dotimes (x 10)
  (print "The sum is " sum)
  (terpri)
  (setq sum (+ sum x)))
\end{lstlisting}
Returns the constant \constant{NIL} and sets \constant{sum} to 45.
\subsection{Description}
On each pass through the loop, the local variable is set to the next value in the range 0 to the loop limit.  The supplied statements are evaluated.  It is not recommended to change the value of the local variable in the body of the loop.  Once the limit is reached, the return value is evaluated, if present.
\subsection{Common Lisp Compatibility}
The declarations and tags are not supported.

\section{dowhile}
Repeats a series of statements while a condition is \constant{T}.
\subsection{Inputs}
Two or more values.  The first value is evaluated as the condition, the remaining values are the statements to be executed while the condition is true.
\subsection{Output}
A value.
\subsection{Example}
\begin{lstlisting}
(dowhile (> (- max min) 1)
  (setq mid (/ (+ min max) 2))
  (if (> mid (/ n mid))
    (setq max mid)
    (setq min mid))
   (+ 0 min))
\end{lstlisting}
Returns the value of the last statement in the loop, \keyword{min}
\subsection{Description}
The condition is evaluated on each pass through the loop.  If the condition evaluates to \constant{T}, the rest of the statements are executed.  If the condition evaluates to \constant{NIL}, the loop is exited.  Thus, if the first time the condition is evaluated it returns \constant{NIL}, the statements in the loop are never executed.
\subsection{Common Lisp Compatibility}
This doesn't appear to exist in \cl.  It is similar to the \cl{} \keyword{do} loop, except that the condition comes first.

\section{dump}
Prints out some internal tables.
\subsection{Inputs}
None.
\subsection{Output}
A value.
\subsection{Example}
\begin{lstlisting}
(dump)
\end{lstlisting}
Returns the constant \constant{NIL}.
\subsection{Description}
This is intended for debugging purposes.  It prints the contents of the cons, symbol, and string tables.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{errorp}
Is parameter a \datatype{error}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
A boolean.
\subsection{Example}
\begin{lstlisting}
(error (1 2 3))
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
If the parameter represents an error condition, return \constant{T}, otherwise return \constant{NIL}.  Effectively, this swallows an error condition and returns a boolean.  This offers \tl{} programs a rudimentary way to check for errors.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.  \cl{} provides more comprehensive error handling, signaling, and trapping.

\section{eval}
Evaluates a \tl{} element.
\subsection{Inputs}
A value.
\subsection{Output}
A value.
\subsection{Example}
\begin{lstlisting}
(eval (read "(+ 1 2 3)"))
\end{lstlisting}
Returns an \datatype{integer} value of 6.
\subsection{Description}
This passes the first parameter to the \tl{} evaluator.  If the parameter is a list and the first element in the list is a \tl{} builtin or special function, or is a symbol for a user defined function, or otherwise a valid \tl{} expression, the expression is evaluated and the result returned.  If the parameter is a symbol, the value of the symbol is returned.  Otherwise, the value of the first parameter is returned.
\subsection{Common Lisp Compatibility}
This is mostly compatible with \cl.

\section{exit}
Exits the \tl{} interpreter.
\subsection{Inputs}
None.
\subsection{Output}
A value.
\subsection{Example}
\begin{lstlisting}
(exit)
\end{lstlisting}
No value can be returned as the interpreter exits..
\subsection{Description}
This is a way to exit the \tl{} interpreter.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl, but some implementations (i.e. SBCL) do have it.

\section{floatp}
Is parameter a \datatype{floating point number}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(floatp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{floating point numbers} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{fresh-line}
Prints a newline if not already at the start of a line.
\subsection{Inputs}
None, any values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(fresh-line)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Checks if the internal first character flag is set.  If not, prints a newline, otherwise does nothing.
\subsection{Common Lisp Compatibility}
There is no optional output-stream parameter as \tl{} only has one output stream.  It also always returns \constant{NIL}.

\section{functionp}
Is parameter a function?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(functionp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Returns \constant{T} if the value is a builtin function, a user defined function, or a lambda function.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{if}
Conditionally executes a statement.
\subsection{Inputs}
Two or three parameters.  The first is a condition.  If the condition evaluates to \constant{T}, the second parameter is evaluated.  If the condition evaluates to \constant{NIL}, the third parameter, if present, is evaluated.
\subsection{Output}
Returns the value of the parameter evaluated.
\subsection{Example}
\begin{lstlisting}
(if (> 1 2)
  (print "Greater")
  (print "Not greater"))
\end{lstlisting}
Prints the string "Not greater".
\subsection{Description}
Evaluates the condition and then depending on the condition, evaluates one of the other parameters.  If the third parameter is omitted, this is approximately equivalent to an \keyword{IF-THEN} statement in other languages.  If the third parameter is present, this is similar to an \keyword{IF-THEN-ELSE} statement.  The value of the evaluated parameter is returned.  If no parameter is evaluated (only two parameters passed and the condition evaluates to \constant{NIL}), then \constant{NIL} is returned.
\subsection{Common Lisp Compatibility}
This seems to be mostly compatible with \cl.

\section{integerp}
Is the parameter an integer?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is an integer, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(integerp 1 2 3)
\end{lstlisting}
Returns the value \constant{T}.
\subsection{Description}
This is used to check if a parameter is of integer type or not.  Currently the only number type supported is integer so this is equivalent to \keyword{numberp} in \tl.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{lambda}
Creates a variable record that can be assigned to a variable or passed as a parameter to a function.
\subsection{Inputs}
The first parameter is a list of the parameters for the function.  The remaining parameters are the operation for the function.
\subsection{Output}
A variable record pointing to the created function.
\subsection{Example}
\begin{lstlisting}
(setq hello (lambda (name) (print "Hello " name)))
\end{lstlisting}
Sets the symbol (or variable depending on context) \keyword{hello} to point to the created function.
\subsection{Description}
Creates a function that can be assigned to a variable or passed as a parameter.  Note that \keyword{(setq var (lambda \dots))} is slightly different from \keyword{(defun var \dots}).  The first creates a variable record and assigns it to \keyword{var} while the second directly sets \keyword{var} to point to the function.  This difference may be removed in future versions.
\subsection{Common Lisp Compatibility}
This is mostly a subset of \cl.

\section{length}
Returns the length of an object.
\subsection{Inputs}
The first parameter is a list of the object to measure.
\subsection{Output}
An integer.
\subsection{Example}
\begin{lstlisting}
(length "Hello")
\end{lstlisting}
Returns the value 5.
\subsection{Description}
Returns the length of an object.  For \datatype{strings} this is the number of characters in a string.  For \datatype{lists} this is the number of items in a list not descending into sublists.  All other datatypes return a value of 1.
\subsection{Common Lisp Compatibility}
This is mostly compatible with \cl, except that errors are not thrown if the parameter is not a sequence.

\section{let}
Creates local variables.
\subsection{Inputs}
A list of variable names and optional initial values followed by statements to be executed with the local variables.
\subsection{Output}
Returns the value of the last statement evaluated.
\subsection{Example}
\begin{lstlisting}
(defun fibi (n)
  (let (temp (n1 0) (n2 1))
    (dotimes (iter n)
      (setq temp (+ n1 n2))
      (setq n1 n2)
      (setq n2 temp))
    n2))
\end{lstlisting}
Defines a function to evaluate Fibonacci numbers using iteration.  The variables \keyword{temp}, \keyword{n1}, and \keyword{n2} are local variables with \keyword{n1} being initialized to the value 0 and \keyword{n2} initialized to the value 1.
\subsection{Description}
Creates a stack frame containing variables that are local to the statements in the block.  Outside of the block the variables do not exist.
\subsection{Common Lisp Compatibility}
Closures are not supported.

\section{list}
Creates a list
\subsection{Inputs}
Any number of parameters.
\subsection{Output}
A list.
\subsection{Example}
\begin{lstlisting}
(list 1 2 3)
\end{lstlisting}
Returns the list \keyword{(1 2 3)}
\subsection{Description}
Creates a list of the passed parameters.
\subsection{Common Lisp Compatibility}
Unlike \cl{}, the \keyword{list} operation is optional in \tl{}.

\section{listp}
Is the parameter a list?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is a list, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(listp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This is used to check if a parameter is a list or not.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{msg}
Turns display of debugging messages on or off.
\subsection{Inputs}
A single boolean value.  Any additional values are ignored.
\subsection{Output}
The value \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(msg T)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This is intended for use in debugging the interpreter to turn the display of some debugging messages on or off.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{not}
Logical or bitwise \keyword{not}.
\subsection{Inputs}
A single value of \datatype{boolean} or \datatype{integer}.
\subsection{Output}
A value of \datatype{boolean} or \datatype{integer}.
\subsection{Example}
\begin{lstlisting}
(not T)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
If the parameter is \datatype{boolean}, perform a logical \keyword{not} operation.  If the parameter is \datatype{integer}, perform a bitwise \keyword{not} operation.
\subsection{Common Lisp Compatibility}
This operation performs a bitwise \keyword{not} for integers.  This is probably more useful for embedded systems.

\section{null}
Is the parameter null?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is null, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(null 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This is used to check if a parameter is null or not.  The empty list is considered to be null while an explicit \constant{NIL} is not.
\subsection{Common Lisp Compatibility}
In \tl{} only the empty list () is treated as null, while \cl{} also treats \constant{NIL} as null.  This may be changed in \tl{} to make it more compatible.

\section{numberp}
Is the parameter a number?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is a number, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(numberp 1 2 3)
\end{lstlisting}
Returns the value \constant{T}.
\subsection{Description}
This is used to check if a parameter is of number type or not.  Currently the only number type supported is integer so this is equivalent to \keyword{integerp} in \tl.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{or}
Logical or bitwise \operation{or}.
\subsection{Inputs}
Performs the logical or bitwise \operation{and} on values of the same type.
\subsection{Output}
If the input parameters are \datatype{boolean} then the output is \datatype{boolean}.  If the input parameters are \constant{integer}, the output is \datatype{integer}.
\subsection{Example}
\begin{lstlisting}
(or 1 3 4)
\end{lstlisting}
Returns the value 7.
\subsection{Description}
If the two parameters are \datatype{boolean}, the result is the logical and of the parameters.  If the two parameters are \datatype{integer}, then the result is the bitwise and of the parameters.  Processing of parameters stop when the result is either \constant{NIL} of \datatype{boolean} values, or 0 (zero) for \datatype{integer} values.
\subsection{Common Lisp Compatibility}
This operation performs a bitwise \keyword{or} for integers.  This is probably more useful for embedded systems.

\section{packagep}
Is parameter a \datatype{package}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(packagep 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{packages} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.
\\
\section{parse-integer}
Parses a \datatype{string} containing an integer as text to an \datatype{integer} value.
\subsection{Inputs}
A \datatype{string} containing an integer.
\subsection{Output}
An \datatype{integer} representing the value in the \datatype{string}.
\subsection{Example}
\begin{lstlisting}
(parse-integer "1024")
\end{lstlisting}
Returns the \datatype{integer} 1024.
\subsection{Description}
This is used to get an integer value from a string containing the digits of an integer.  To simplify the coding, only the first fragment of the string is examined for digits.  Parameters not of \datatype{string} cause an \keyword{error} to be returned.  Strings starting with non-integer values return 0.  Parsing is terminated when a non digit character is encountered (thus the \datatype{string} ``123abc'' is parsed to the \datatype{integer} 123).
\subsection{Common Lisp Compatibility}
The \tl{} version is a subset of the \cl{} version.  None of the \cl{} optional parameters are allowed.  It operates similarly to having \keyword{:junk-allowed} set to \constant{T}. Leading spaces are not allowed.  A leading plus sign ('+`) is not allowed.  Only a single value is returned.

\section{peek8}
Reads an 8 bit byte from the specified address in memory.
\subsection{Inputs}
An \datatype{integer} representing the address to read from.
\subsection{Output}
An 8 bit \datatype{integer} representing the value at that address.
\subsection{Example}
\begin{lstlisting}
(peek 1)
\end{lstlisting}
Returns the value at address 1.  The actual value is system dependent.
\subsection{Description}
This is used to read memory locations.  It is intended to be used with memory mapped devices to allow drivers to be developed using \tl{}.  This should be used with caution as the results are strongly system dependent.  No protection is provided by \tl{} to prevent attempting to read from protected or non-existent addresses.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{peek16}
Reads a 16 bit word from the specified address in memory.
\subsection{Inputs}
An \datatype{integer} representing the address to read from.
\subsection{Output}
A 16 bit \datatype{integer} representing the value at that address.
\subsection{Example}
\begin{lstlisting}
(peek 1)
\end{lstlisting}
Returns the value at address 1.  The actual value is system dependent.
\subsection{Description}
This is used to read memory locations.  It is intended to be used with memory mapped devices to allow drivers to be developed using \tl{}.  This should be used with caution as the results are strongly system dependent.  No protection is provided by \tl{} to prevent attempting to read from protected or non-existent addresses.  Some systems may also throw exceptions for misaligned access to some or all of the addresses.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{peek32}
Reads a 32 bit word from the specified address in memory.
\subsection{Inputs}
An \datatype{integer} representing the address to read from.
\subsection{Output}
A 32 bit \datatype{integer} representing the value at that address.
\subsection{Example}
\begin{lstlisting}
(peek 1)
\end{lstlisting}
Returns the value at address 1.  The actual value is system dependent.
\subsection{Description}
This is used to read memory locations.  It is intended to be used with memory mapped devices to allow drivers to be developed using \tl{}.  This should be used with caution as the results are strongly system dependent.  No protection is provided by \tl{} to prevent attempting to read from protected or non-existent addresses.  Some systems may also throw exceptions for misaligned access to some or all of the addresses.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{poke8}
Writes an 8 bit byte to the specified address in memory.
\subsection{Inputs}
Two \datatype{integer}s representing the address to write to and the value to write, respectively.
\subsection{Output}
The \datatype{integer} value written.
\subsection{Example}
\begin{lstlisting}
(poke 1 2)
\end{lstlisting}
Returns the value 2.  There may be other effects due to the memory being changed.
\subsection{Description}
This is used to write to memory locations.  It is intended to be used with memory mapped devices to allow drivers to be developed using \tl{}.  This should be used with caution as the results are strongly system dependent.  No protection is provided by \tl{} to prevent attempting to write to protected or non-existent addresses.  Some systems may also throw exceptions for misaligned access to some or all of the addresses.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{poke16}
Writes a 16 bit word to the specified address in memory.
\subsection{Inputs}
Two \datatype{integer}s representing the address to write to and the value to write, respectively.
\subsection{Output}
The \datatype{integer} value written.
\subsection{Example}
\begin{lstlisting}
(poke 4 2)
\end{lstlisting}
Returns the value 2.  There may be other effects due to the memory being changed.
\subsection{Description}
This is used to write to memory locations.  It is intended to be used with memory mapped devices to allow drivers to be developed using \tl{}.  This should be used with caution as the results are strongly system dependent.  No protection is provided by \tl{} to prevent attempting to write to protected or non-existent addresses.  Some systems may also throw exceptions for misaligned access to some or all of the addresses.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{poke32}
Writes a 32 bit word to the specified address in memory.
\subsection{Inputs}
Two \datatype{integer}s representing the address to write to and the value to write, respectively.
\subsection{Output}
The \datatype{integer} value written.
\subsection{Example}
\begin{lstlisting}
(poke 4 2)
\end{lstlisting}
Returns the value 2.  There may be other effects due to the memory being changed.
\subsection{Description}
This is used to write to memory locations.  It is intended to be used with memory mapped devices to allow drivers to be developed using \tl{}.  This should be used with caution as the results are strongly system dependent.  No protection is provided by \tl{} to prevent attempting to write to protected or non-existent addresses.  Some systems may also throw exceptions for misaligned access to some or all of the addresses.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.

\section{print}
Prints objects.
\subsection{Inputs}
Any number of parameters.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(print "Hello world!")
\end{lstlisting}
Returns the value \constant{NIL}.  ``Hello world!'' is sent to the output stream.
\subsection{Description}
This loops through the provided parameters and prints each one with no newline or space between and no trailing newline.  Note that if a newline is contained in one of the items printed, the internal flag \keyword{first\_char\_flag} is not set.  This may cause \keyword{fresh-line} to output an unneeded newline.
\subsection{Common Lisp Compatibility}
The output is not preceded by a newline and followed by a space.  The optional \keyword{output-stream} parameter is not available as there is only one output stream.  Multiple parameters are permitted.  And, there is no implicit binding of parameters to values.

\section{print-hex}
Prints numbers in unsigned hexadecimal notation.
\subsection{Inputs}
One or two parameters.  The first is the number to print.  The second is the size (1=byte, 2=word, anything else is long).  If the second is omitted, a size of long is assumed.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(print-hex 1023 1)
\end{lstlisting}
Returns the value \constant{NIL}.  ``FF'' is sent to the output stream.
\subsection{Description}
The number is internally converted to an unsigned integer and truncated to the specified size.  If no size is specified, long is used.  The number is then printed to the output stream as a hexadecimal number with leading zeros appropriate for the size.
\subsection{Common Lisp Compatibility}
This operation does not exist in \cl.  It was added for convenience when working with embedded systems.

\section{progn}
Collects operations into a block.
\subsection{Inputs}
List of statements to be evaluated.
\subsection{Output}
The result of the last statement evaluated.
\subsection{Example}
\begin{lstlisting}
(progn (print "Hello world!")
       (terpri)
       (+ 1 3))
\end{lstlisting}
Prints the string ``Hello world!'' and returns the value 4.
\subsection{Description}
This is used when multiple operations are needed in a place where only a single operation is permitted.  An example is the \keyword{if} operation.
\subsection{Common Lisp Compatibility}
This is basically compatible with \cl.

\section{quote}
Returns a list created from the supplied parameters.
\subsection{Inputs}
Any number of parameters.
\subsection{Output}
A list generated from the input parameters.
\subsection{Example}
\begin{lstlisting}
(quote 1 2 3 4)
\end{lstlisting}
Returns the list (1 2 3 4).
\subsection{Description}
Returns a list generated from the passed parameters.  Internally, this returns the index of the cons cell for the first parameter and the rest of the parameter list follows along in the linked list.  The parameters are not evaluated.  In many cases, this may not be needed in \tl{} as lists that do not start with a function parameter are simply returned as-is.
\subsection{Common Lisp Compatibility}
Mostly compatible with \cl, except that multiple parameters are permitted.

\section{rationalp}
Is parameter a \datatype{rational number}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(rationalp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{rational numbers} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{read}
Reads text from a \datatype{string} and attempts to parse it as a \tl{} expression.
\subsection{Inputs}
A \datatype{string}.
\subsection{Output}
A \datatype{list}.
\subsection{Example}
\begin{lstlisting}
(read "(+ 1 2)")
\end{lstlisting}
Returns a \datatype{list} containing `+', `1', and `2'.
\subsection{Description}
Redirects the parser input to read from a \datatype{string} in order to parse it as a \tl{} expression.
\subsection{Common Lisp Compatibility}
None of the \cl{} optional parameters are supported and input can only come from a \datatype{string}.

\section{read-line}
Reads a line of text from the input stream.
\subsection{Inputs}
None.
\subsection{Output}
A \datatype{string} read from the input stream.
\subsection{Example}
\begin{lstlisting}
(read-line)
\end{lstlisting}
Returns the text read from the input.
\subsection{Description}
Reads input into a \datatype{string} and returns the \datatype{string}.  The newline that ends the string is not included in the string.
\subsection{Common Lisp Compatibility}
None of the \cl{} optional parameters are supported.

\section{realp}
Is parameter a \datatype{real number}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(realp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{real numbers} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{return}
Exits a block and returns a value
\subsection{Inputs}
An optional value to be returned.  If none is specified, \constant{NIL} is assumed.
\subsection{Output}
The specified value.
\subsection{Example}
\begin{lstlisting}
(progn (print "Hello world!")
       (terpri)
       (return 5)
       (+ 1 3))
\end{lstlisting}
Prints the string ``Hello world!'' and returns the value 5.  The \operation{(+ 1 3)} operation is not evaluated.
\subsection{Description}
This is used to provide an early exit from a block.  A common use would be to exit a loop if a certain condition is met.  Internally, a block is defined as any operation that calls the \function{execute\_block} function.  It may be possible in the future to do an equivalent of the \keyword{return-from} operation to exit multiple nested blocks, but \tl{} doesn't support named blocks so any implementation would likely not be compatible with \cl.
\subsection{Common Lisp Compatibility}
This is basically compatible with \cl.

\section{rplaca}
Replaces the \operation{car} of a \datatype{cons} cell with the specified value.
\subsection{Inputs}
A list and a value of any type.
\subsection{Output}
The list modified with the specific value.
\subsection{Example}
\begin{lstlisting}
(setq a (1 2 3 4 5))
(rplaca a "Hello")
\end{lstlisting}
Returns the list ``("Hello" 2 3 4 5)'' and modifies the list ``a''.
\subsection{Description}
This is used to modify a \datatype{cons} cell.  The \keyword{car} slot is changed to contain the new value and the updated \datatype{cons} cell returned.
\subsection{Common Lisp Compatibility}
This is basically compatible with \cl.

\section{rplacd}
Replaces the \operation{cdr} of a \datatype{cons} cell with the specified value.
\subsection{Inputs}
A list and a value of any type.
\subsection{Output}
The list modified with the specific value.
\subsection{Example}
\begin{lstlisting}
(setq a (1 2 3 4 5))
(rplacd a (6 7))
\end{lstlisting}
Returns the list ``(1 6 7)'' and modifies the list ``a''.
\subsection{Description}
This is used to modify a \datatype{cons} cell.  The \keyword{cdr} slot is changed to contain the new value and the updated \datatype{cons} cell returned.
\subsection{Common Lisp Compatibility}
This is basically compatible with \cl.

\section{setq}
Assigns a value to a variable.
\subsection{Inputs}
Two parameters.  The first is the variable to be set.  If this is not a stack variable, it will be interpreted as a symbol.  The second is the value to assign to the variable.  It is evaluated.
\subsection{Output}
\constant{NIL}
\subsection{Example}
\begin{lstlisting}
(setq counter (+ 1 counter))
\end{lstlisting}
Returns the value \constant{NIL} and increments the variable \keyword{counter}.
\subsection{Description}
This provides a way to assign values to symbols or stack variables.  The previous value of the variable is lost.  Note that symbols representing builtin or special functions cannot be assigned.
\subsection{Common Lisp Compatibility}
Only one variable can be set at a time.  It returns \constant{NIL}, not the value set.

\section{simple-bit-vector-p}
Is parameter a \datatype{simple bit vector}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(simple-bit-vector-p 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{bit vectors} (simple or otherwise) are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{simple-string-p}
Is the parameter a simple string?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is a string, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(simple-string-p 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This is used to check if a parameter is a simple string or not.  All strings in \tl{} are considered to be simple strings.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{simple-vector-p}
Is parameter a \datatype{simple vector}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(simple-vector-p 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{vectors} (simple or otherwise) are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{sleep}
Suspend execution for the specified number of milliseconds.
\subsection{Inputs}
A single \datatype{integer} value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(sleep 100)
\end{lstlisting}
Returns the value \constant{NIL} after waiting 100 mS.
\subsection{Description}
Suspends execution for the specified number of milliseconds.  Since \tl{} only supports integers, this difference from \cl{} was done in order to allow finer resolutions in delay.
\subsection{Common Lisp Compatibility}
The delay value is in milliseconds, not seconds.

\section{string-downcase}
Converts a string to lowercase ASCII.
\subsection{Inputs}
A single \datatype{string} value.  Any additional values are ignored.
\subsection{Output}
A \datatype{string}.
\subsection{Example}
\begin{lstlisting}
(string-downcase "Hello World!")
\end{lstlisting}
Returns the \datatype{string} ``hello world!''.
\subsection{Description}
Creates a copy of the input \datatype{string} converting any uppercase characters to lowercase.
\subsection{Common Lisp Compatibility}
The optional \keyword{start} and \keyword{end} parameters are not supported.  Only ASCII characters are supported and only the characters `A' through `Z' are converted.

\section{string-upcase}
Converts a string to uppercase ASCII.
\subsection{Inputs}
A single \datatype{string} value.  Any additional values are ignored.
\subsection{Output}
A \datatype{string}.
\subsection{Example}
\begin{lstlisting}
(string-upcase "Hello World!")
\end{lstlisting}
Returns the \datatype{string} ``HELLO WORLD!''.
\subsection{Description}
Creates a copy of the input \datatype{string} converting any lowercase characters to uppercase.
\subsection{Common Lisp Compatibility}
The optional \keyword{start} and \keyword{end} parameters are not supported.  Only ASCII characters are supported and only the characters `a' through `z' are converted.

\section{stringp}
Is the parameter a string?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is a string, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(stringp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This is used to check if a parameter is a string or not..
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{subseq}
Return a subsequence of the input.
\subsection{Inputs}
A single \datatype{string} followed by one or two \datatype{integers} representing the starting and (optional) ending positions.
\subsection{Output}
A \datatype{string} containing a sequence copied from the input.
\subsection{Example}
\begin{lstlisting}
(subseq "Hello world!" 3 7)
\end{lstlisting}
Returns the \datatype{string} ``lo w''..
\subsection{Description}
Copies the selected text from the input string and returns it.
\subsection{Common Lisp Compatibility}
In \tl, \keyword{subseq} only works on \datatype{strings}.  At some point, it may be extended to also work on \datatype{lists}.

\section{symbolp}
Is the parameter a symbol?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
The value \constant{T} if the parameter is a symbol, otherwise \constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(symbolp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
This is used to check if a parameter is a symbol or not.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.

\section{terpri}
Prints a newline.
\subsection{Inputs}
None
\subsection{Output}
A newline.
\subsection{Example}
\begin{lstlisting}
(terpri)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Prints a newline to the output stream.
\subsection{Common Lisp Compatibility}
\tl() has only one output stream so the optional output stream designator is ignored.

\section{vectorp}
Is parameter a \datatype{vector}?
\subsection{Inputs}
A single value.  Any additional values are ignored.
\subsection{Output}
\constant{NIL}.
\subsection{Example}
\begin{lstlisting}
(vectorp 1 2 3)
\end{lstlisting}
Returns the value \constant{NIL}.
\subsection{Description}
Since \datatype{vectors} are not a supported datatype, this always returns \constant{NIL}.
\subsection{Common Lisp Compatibility}
This is compatible with \cl, except that no error is thrown with extra parameters.  They are just silently ignored.
%----------------------------------------------------------
\chapter{Internals}
\textbf{As the interpreter is under active development, this section is subject to change without notice.}

\section{Operation}
Processing consists of four phases.

\subsection{Read}
Text is read from the input stream and passed to the parser.  Currently two input streams are supported.  The first is from standard input - usually the keyboard.  This is the default.  The second is from a \tl{} string.  This is used by the \operation{(read ...)} operation.

\subsection{Parse}
The parse phase examines the text and converts it into the internal representation of a list.  If the list is not complete (parentheses are unbalanced), more text is requested until the list can be completed.  Parsing of sub-lists is done by recursively calling the parser.

\subsection{Evaluate}
The list from the parse phase is evaluated.  If the first in the list is not a symbol that represents a function, the list is simply returned as is.  Otherwise the function is evaluated and the returned value is passed to the print phase.  Evaluation of sub-lists is done recursively.  Note that, depending on the function, not all sub-lists are evaluated.

\subsection{Print}
The value returned from the evaluation is printed.  Once this is done, the read phase is reentered and more text requested.

\section{Package Organization}
In order to help modularize and organize the code, it has been divided into several packages.  The root package for \tl{} is \package{BBS.lisp}.  The \package{BBS} package is basically a bucket for my projects to help prevent name collisions with any other packages.

\subsection{\package{BBS.lisp}}
This package is the root package for \tl{}.  It contains most of the data structures and the public interface for the interpreter.  In addition, a number of common utility function are defined here so that they can be used in all the child packages.

\subsubsection{\package{bbs.lisp.evaluate}}
This package contains child packages for evaluating the \tl{} operations as well as common functions used by its children.  To keep it a reasonable size, the following child packages have been broken out:
\begin{itemize}
  \item \package{BBS.lisp.evaluate.bool} - Contains operations relating to \datatype{boolean} values.
  \item \package{BBS.lisp.evaluate.char} - Contains operations relating to \datatype{character} values.
  \item \package{BBS.lisp.evaluate.cond} - Contains \tl{} conditional operations.
  \item \package{BBS.lisp.evaluate.func} - Contains operations related to defining functions.
  \item \package{BBS.lisp.evaluate.io} - Contains \tl{} input/output operations.
  \item \package{BBS.lisp.evaluate.list} - Contains operations relating to \datatype{list} values.
  \item \package{BBS.lisp.evaluate.loops} - Contains \tl{} loop operations.
  \item \package{BBS.lisp.evaluate.math} - Contains \tl{} math operations.
  \item \package{BBS.lisp.evaluate.mem} - Contains \tl{} memory access operations.
  \item \package{BBS.lisp.evaluate.misc} - Contains operations that don't fit into any other catagory.
  \item \package{BBS.lisp.evaluate.pred} - Contains predicate (test) operations.
  \item \package{BBS.lisp.evaluate.str} - Contains operations relating to \datatype{string} values.
  \item \package{BBS.lisp.evaluate.symb} - Contains operations relating to symbols.
  \item \package{BBS.lisp.evaluate.vars} - Contains operations relating to variables.
\end{itemize}

\subsubsection{\package{BBS.lisp.global}}
This package contains the stack.  It may be deleted at some point and the actual stack moved back into \package{BBS.lisp.stack}.

\subsubsection{\package{BBS.lisp.info}}
This is an auto-generated package that contains some constants that can be used to identify the version and build date.

\subsubsection{\package{BBS.lisp.memory}}
This package contains the memory manager.  This is mainly allocating items and incrementing and decrementing the reference count.

\subsubsection{\package{BBS.lisp.parser}}
This package contains the parser.  The two input streams are provided by the following child packages:
\begin{itemize}
  \item \package{BBS.lisp.parser.stdio} - Provides the primary keyboard input method.
  \item \package{BBS.lisp.parser.string} - Provides an input method to read from \tl{} \datatype{strings}.
\end{itemize}

\subsubsection{\package{BBS.lisp.stack}}
This package contains the stack and functions for accessing the stack.

\subsubsection{\package{BBS.lisp.strings}}
This package contains some utility functions for strings.

\subsubsection{\package{BBS.lisp.symbols}}
This package contains definitions for symbols and functions for operating on them.  The fixed symbol array is also defined here.

\subsubsection{\package{BBS.lisp.utilities}}
This package contains some general utility functions.


\section{Data Structures}
Most of the data structures are defined in the \package{BBS.lisp} package, except for the stack, which is defined in \package{BBS.lisp.stack}.

The main arrays have size limits and data types defined for accessing them.  These may change if the \keyword{bbs.lisp} package gets turned into a generic package.  Should that happen The four constants will be the generic parameters.  This will make adjusting the size of the structures a little easier when embedding.
\lstset{language=Ada}
\begin{lstlisting}
   max_cons : constant Integer := 500;
   max_symb : constant Integer := 250;
   max_string : constant Integer := 450;
   max_stack : constant Integer := 100;
   --
   type cons_index is range -1 .. max_cons;
   type symb_index is range -1 .. max_symb;
   type string_index is range -1 .. max_string;
   type fsymb_index is new Positive;
\end{lstlisting}

The arrays are defined from \constant{\ldots{}\_index'First + 1} to \constant{\ldots\_index'Last}.  The value \constant{\ldots\_index'First} is used to represent an invalid or null index.  The following constants are defined for this:
\begin{lstlisting}
   NIL_CONS : constant cons_index := cons_index'First;
   NIL_STR : constant string_index := string_index'First;
\end{lstlisting}

Since symbols can be found in either the static or dynamic symbol tables, the symbol pointer needs to indicate which to use.  It is defined as follows:
\begin{lstlisting}
   type symbol_table is (ST_NULL, ST_FIXED, ST_DYNAMIC);
   --
   --  Pointer to a symbol.  This needs to be able to distinguish between symbols
   --  that are in the fixed table and the dynamic table.
   --
   type symbol_ptr(kind : symbol_table := ST_NULL) is
      record
         case kind is
            when ST_NULL =>
               null;
            when ST_FIXED =>
               f : fsymb_index;
            when ST_DYNAMIC =>
               d : symb_index;
         end case;
      end record;
\end{lstlisting}

\subsection{Elements}
The basic data type is the element.  It is defined as follows:
\lstset{language=Ada}
\begin{lstlisting}
   type value_type is (V_INTEGER, V_STRING, V_CHARACTER, V_BOOLEAN, V_LIST,
                       V_LAMBDA, V_TEMPSYM, V_SYMBOL, V_QSYMBOL, V_STACK,
                       V_ERROR, V_NONE);
   type element_type(kind : value_type := V_INTEGER) is
      record
         case kind is
         when V_INTEGER =>
            i : int32;
         when V_CHARACTER =>
            c : Character;
         when V_STRING =>
            s : string_index;
         when V_BOOLEAN =>
            b : Boolean;
         when V_LIST =>
            l : cons_index;
         when V_LAMBDA =>
            lam : cons_index;
         when V_TEMPSYM =>
            tempsym : string_index;
         when V_SYMBOL =>
            sym : symbol_ptr;
         when V_QSYMBOL =>
            qsym : symbol_ptr;
         when V_STACK =>
            st_name : string_index;
            st_offset : Natural;
         when V_ERROR =>
            err : error_code;
         when V_NONE =>
            null;
         end case;
      end record;
\end{lstlisting}

The different types of elements are:
\begin{description}
  \item[V\_BOOLEAN] Contains a \datatype{boolean} value of either \constant{False} or \constant{True}.
  \item[V\_CHARACTER] Contains an ASCII \datatype{character} value.
  \item[V\_ERROR] This indicates that some operation has encountered an error of some sort.
  \item[V\_INTEGER] This is the basic numeric type and contains a 32 bit \datatype{integer}.
  \item[V\_LAMBDA] This is a special form of list that represents executable code.  It is an index into the array of \datatype{cons} cells as described in section \ref{sec:Cons}
  \item[V\_LIST] Contains an index into the array of \datatype{cons} cells as described in section \ref{sec:Cons}.
  \item[V\_NONE] This represents an empty element.
  \item[V\_QSYMBOL] This represents a quoted \datatype{symbol}.  It is being used for its name rather than its value.
  \item[V\_STACK] This represents a stack variable.  It contains an index into the \datatype{string} table for the variable's name and a stack frame offset.
  \item[V\_STRING] This contains an index into the \datatype{string} table and represents a \tl{} \datatype{string}.
  \item[V\_SYMBOL] This contains an index into the \datatype{symbol} table thus representing a symbol as described in section \ref{sec:Symbols}.
  \item[V\_TEMPSYM] This contains an index into the \datatype{string} table for representing a temporary symbol name.  This is used during parsing to represent an item where the type has not yet been determined.  It should never appear once parsing is complete.
\end{description}

\subsection{Cons}
\label{sec:Cons}
Cons elements are used to make lists.  A cons cell is defined as
\begin{lstlisting}
   type cons is
      record
         ref : Natural;
         car : element_type;
         cdr : element_type;
      end record;
\end{lstlisting}

\subsection{Symbols}
\label{sec:Symbols}
Symbols are defined as:
\begin{lstlisting}
   type symbol_type is (SY_SPECIAL,  -- A special form that needs
                                     --  support during parsing
                        SY_BUILTIN,  -- A normal builtin function
                        SY_LAMBDA,   -- A user defined function
                        SY_VARIABLE, -- A value, not a function
                        SY_EMPTY);   -- No contents
   type execute_function is access function(e : element_type)
     return element_type;
   type special_function is access function(e : element_type;
                                            p : phase)
    return element_type;
   type symbol(kind : symbol_type := SY_EMPTY) is
      record
         ref : Natural;
         str : string_index;
         case kind is
            when SY_SPECIAL =>
               s : special_function;
            when SY_BUILTIN =>
               f : execute_function;
            when SY_LAMBDA =>
               ps : cons_index;
            when SY_VARIABLE =>
               pv : element_type;
            when SY_EMPTY =>
               null;
         end case;
      end record;
\end{lstlisting}

\subsubsection{SY\_BUILTIN vs SY\_SPECIAL}
Some functions need to be able to access some of their parameters during parsing so that the rest of the parameters can be properly parsed.  Usually, but not always, this involves building a stack frame with the parameters so that they will be properly identified during further processing.  These functions are passed an extra parameter \emph{p} for phase.  The possible values are:
\begin{lstlisting}
   type phase is (PH_QUERY, PH_PARSE_BEGIN, PH_PARSE_END, PH_EXECUTE);
\end{lstlisting}

The phases are:
\begin{description}
  \item[PH\_QUERY] Initial call to the function to query the function when it wants to be called again.  The function returns an integer value indicating the parameter after which it should be called.
  \item[PH\_PARSE\_BEGIN] This is the call after the desired parameter has been parsed.  The function can then examine this parameter and make any needed changes.
  \item[PH\_PARSE\_END] This is the call at the end of parsing for the function.  Usually this just clears the stack frame.  It could also be used for things like preprocessing the parameter list.
  \item[PH\_EXECUTE] This is the call for execution where the function performs its normal operation.
\end{description}

\subsection{Strings}
\label{sec:strings}
Strings are stored as a set of string fragments in a linked list.  Thus, the length of a string is limited only by the number of fragments available.  Strings are defined as:
\begin{lstlisting}
   fragment_len : constant Integer := 16;
   type fragment is
      record
         ref : Natural;
         next : Integer range -1 .. Integer(string_index'Last);
         len : Integer range 0..fragment_len;
         str : String (1..fragment_len);
      end record;
\end{lstlisting}

\subsection{Functions}
\label{sec:Functions}
A function is a list that contains two elements.  The first element is a list of the function parameters.  The second element is a list of the function's statements.

\subsection{The Stack}
\label{sec:Stack}
A stack is defined for storing function parameters and local variables.  The function parameters are used only for user defined functions.  Builtin and Special functions are handled within the Ada code directly from the \emph{cons} cells of the function parameter list.  Stack entries are defined as follow:
\begin{lstlisting}
   type stack_entry_type is (ST_EMPTY, ST_FRAME, ST_VALUE);
   type stack_entry(kind : stack_entry_type := ST_EMPTY) is
      record
         case kind is
            when ST_EMPTY =>
               null;
            when ST_FRAME =>
               number: Natural;
               next : stack_index;
            when ST_VALUE =>
               st_name : string_index;
               st_value : value;
         end case;
      end record;
\end{lstlisting}
Each stack entry can be empty, a stack frame boundary, or a variable.  Stack variables have a name and a value.  The stack itself is defined as a tagged record as follows:
\begin{lstlisting}
   type lisp_stack_array is array (Natural range <>) of stack_entry;
   type lisp_stack(size : Natural) is tagged record
      sp : Natural;  -- Stack pointer
      fp : Natural;  -- Frame pointer
      fc : Natural;  -- Frame counter
      stack : lisp_stack_array (0 .. size);
   end record;
\end{lstlisting}
Currently, only one stack is defined in \package{BBS.lisp.globals}.

\subsection{Global Data}
The various data arrays are defined as follows.

The actual arrays are (in \package{bbs.lisp}):
\begin{lstlisting}
   --
   --  Since this interpreter is designed to be used on embedded computers
   --  with no operating system and possibly no dynamic memory allocation,
   --  The statically allocated data structures are defined here.
   --
   cons_table : array (cons_index'First + 1 .. cons_index'Last) of cons;
   symb_table : array (symb_index'First + 1 .. symb_index'Last) of symbol;
   string_table : array (string_index'First + 1 .. string_index'Last)
                  of fragment;
\end{lstlisting}
And in the stack package (\package{bbs.lisp.stack}):
\begin{lstlisting}
   --
   --  The stack array
   --
   stack : array (stack_index'First + 1 .. stack_index'Last) of
           stack_entry := (others => (kind => ST_EMPTY));
\end{lstlisting}
Note that all the arrays have a lower bound of \constant{\ldots'first+1}.  This allows an index value equal to \constant{\ldots'first} to be used to indicate a null entry.

\subsection{Memory Management}
Memory management is done by reference counting.  When the number of references goes to zero, the item is deallocated.  Items in the cons table and the strings table are reference counted.

\section{Utility Functions}
There are a number of functions that are available for use when embedding and extending \tl{}.  These are primarily only in a few packages and they may be moved to improve organization.
\subsection{\package{BBS.lisp}}
The functions available here are primarily concerned with the overall operation of the interpreter.  The first procedure to call is:
\begin{lstlisting}
   procedure init(p_put_line : t_put_line; p_put : t_put_line;
                  p_new_line : t_newline; p_get_line : t_get_line);
\end{lstlisting}
This routine is used to establish pointers to the I/O functions used and to define the symbols for builtin and special functions.  After this symbols for custom functions can be added.  The following procedure is used for that:
\begin{lstlisting}
   procedure add_builtin(n : String; f : execute_function);
\end{lstlisting}
To pass control to the \tl{} read-execute-print-loop, the following procedure is used:
\begin{lstlisting}
   procedure repl;
\end{lstlisting}
If more control is needed, the read-execute-print-loop can be broken out using the following functions and procedure:
\begin{lstlisting}
   function read return Element_Type;
   function eval(e : element_type) return element_type;
   procedure print(e : element_type; d : Boolean; nl : Boolean);
   function exit_lisp return Boolean;
\end{lstlisting}
These would be used in a loop as follows:
\begin{lstlisting}
   procedure repl is
      e : element_type;
      r : element_type;
   begin
      exit_flag := False;
      break_flag := false;
      while True loop
         BBS.lisp.stack.reset;
         e := read;
         if e.kind /= E_ERROR then
            r := eval(e);
            if not first_char_flag then
               new_line;
            end if;
            print(r, True, True);
         end if;
         exit when exit_lisp;
      end loop;
   end;
\end{lstlisting}
For writing custom functions, the following functions may be useful:
\begin{lstlisting}
   procedure error(f : String; m : String);
   procedure msg(f : String; m : String);
   procedure print(e : element_type; d : Boolean; nl : Boolean);
\end{lstlisting}
These support printing error and informational messages as well as printing \tl{} elements.  There are other useful functions in some other packages as well.
\subsection{\package{BBS.lisp.evaluate}}
This package contains functions useful in the evaluation of \tl{} operations.  The most useful, when adding custom operations, is:
\begin{lstlisting}
   function first_value(s : in out cons_index) return element_type;
\end{lstlisting}
It extracts the first element from the list pointed to by \keyword{s} and updates \keyword{s} to point to the next element in the list.  If the first element is a variable, the value of the variable is returned.  If the first element is a \tl{} operation, it is evaluated and the result of the evaluation is returned.

\subsection{\package{BBS.lisp.utilities}}

\section{Embedding}
This section covers how too embed the list interpreter in another program.  Here is a minimal host program:
\begin{lstlisting}
with Ada.Text_IO;
with bbs.lisp;
with new_line;
--
--  This is a simple shell routine to call the embedded lisp
--  interpreter.
--
procedure Lisp is
begin
   Ada.Text_IO.Put_Line("Tiny lisp interpreter written in Ada.");
   bbs.lisp.init(Ada.Text_IO.Put_Line'Access, Ada.Text_IO.Put'Access,
                new_line.New_Line'Access, Ada.Text_IO.Get_Line'Access);
   bbs.lisp.repl;
end Lisp;
\end{lstlisting}

With \function{new\_line} defined as:
\begin{lstlisting}
--
--  The text_io version of newline contains an optional parameter
--  indicating the number of lines to skip.  The type of this parameter
--  is defined in Ada.Text_IO.  This makes it awkward to define a
--  function prototype that can be used both when Ada.Text_IO is
--  available and when it isn't.  This is a crude hack to define
--  locally a new_line that has no parameters and uses the
--  Ada.Text_IO new_line with the default value.
--
package new_line is
   procedure new_line;
end new_line;

with Ada.Text_IO;
package body new_line is

   procedure new_line is
   begin
      Ada.Text_IO.New_Line;
   end;

end new_line;
\end{lstlisting}

It's fairly simple.  Initialize the interpreter and call it.  The only wrinkle is the need to define \function{new\_line}.  The Ada version has an optional parameter of a type defined in \package{Ada.Text\_IO}.  This is a problem when trying to eliminate dependencies on \package{Ada.Text\_IO}.  A more complex example of embedding is found in the \url{https://github.com/BrentSeidel/Ada-Lisp-Embedded} repository.  This repository contains code that runs on an Arduino Due and includes the definition of several \tl{} operations to access attached hardware.

\subsection{Adding Custom Operations}
The Ada functions that implement the \tl{} operations are defined using one of the two following prototypes:
\begin{lstlisting}
   --
   --  Type for access to function that implement lisp operations.
   --
   type execute_function is access procedure(e : out element_type;
             s : cons_index);
   --
   --  Type for access to functions that implement lisp special
   --  operations
   --
   type special_function is access procedure(e : out element_type;
             s : cons_index; p : phase);
\end{lstlisting}
In most cases, an \datatype{execute\_function} is the type to use and \datatype{special\_function} is defined in the \keyword{private} section to discourage use.  To install the operation, add something like the following line after the main \tl{} initialization function is called.
\begin{lstlisting}
      BBS.lisp.add_builtin("due-flash", due_flash'Access);
\end{lstlisting}
The first parameter to \keyword{add\_builtin} is a string giving the \tl{} operation name.  The second parameter is an access to the Ada function to call.

In the function that you write, the parameter \keyword{s} is an index pointing to the start of the parameter list.  Thus a \tl{} expression like:
\lstset{language=[Tiny]Lisp}
\begin{lstlisting}
(some-function 1 2 3)
\end{lstlisting}
is translated into a linked list approximately like:
\begin{lstlisting}
symbol.builtin("some-function")->
  value.integer(1)->
    value.integer(2)->
      value.integer(3)->
        NIL_CONS
\end{lstlisting}
The first element is turned into the Ada function call with \keyword(s) pointing to the second element (value.integer(1)).  The Ada function can then traverse the list and extract the \tl{} parameters.
\lstset{language=Ada}


\section{Opportunities for Optimizing}
No big effort has gone into optimizing the interpreter.  Should the need arise, there are a few places where things could be optimized.

\subsection{Memory Management}
If allocation becomes a bottleneck, the free items could be linked together in a list.  That way a new item could be picked off the head of the list instead of searching through all the items.  This would also require the list to be created at initialization.

\subsection{Constant expressions}
During parsing, it may be possible to recognize some constant expressions are replace them by their result.  For example:
\lstset{language=[Tiny]Lisp}
\begin{lstlisting}
(+ 1 2 3) -> 6
\end{lstlisting}

\subsection{The Symbol Table}
An obvious target for optimization would be to sort the symbol table.  Then a binary search could be done to locate symbols.  The reason that this is not done is that searching for symbols is only done during parsing.  The parser locates the symbol in the table and replaces it by its index.  During execution, the symbol index is used to directly access the symbol without doing a search.  This means that once a symbol is defined, it must never change its location in the table.

\end{document}

